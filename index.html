<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iOS対応 マーカーAR + Hand Pinch Vision UI</title>
<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; }
  #hint {
    position: fixed; top: 10px; left: 10px;
    background: rgba(255,255,255,0.8); padding: 6px 10px; border-radius: 6px; z-index:10;
  }
  #videoElement { display: none; }
</style>
<!-- A-Frame -->
<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<!-- AR.js -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
</head>
<body>
<div id="hint">Hiroマーカーをカメラに向けて、親指と人差し指でピンチ操作してください。</div>
<video id="videoElement" autoplay playsinline></video>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
  <!-- Hiroマーカー -->
  <a-marker preset="hiro">
    <!-- Vision風パネル -->
    <a-plane id="panel" position="0 0.5 0" width="0.6" height="0.4" color="#ffffff" opacity="0.9">
      <a-text id="panelText" value="Pinch Me" color="#000000" align="center" width="2" position="0 0 0.01"></a-text>
    </a-plane>
  </a-marker>
  <a-entity camera></a-entity>
</a-scene>

<script>
const video = document.getElementById('videoElement');
let model = null;
let panel = document.getElementById('panel');

// カメラアクセス
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
.then(stream => { video.srcObject = stream; })
.catch(err => { alert("カメラアクセス不可: " + err); });

// MediaPipe Handpose モデル読み込み
handpose.load().then(loadedModel => {
  model = loadedModel;
  detectHands();
});

// 手の検出ループ
async function detectHands() {
  if (model && video.readyState === 4) {
    const predictions = await model.estimateHands(video);
    if (predictions.length > 0) {
      const hand = predictions[0];

      // 指先ランドマーク
      const thumbTip = hand.annotations.thumb[3];    // [x, y, z]
      const indexTip = hand.annotations.indexFinger[3];

      // ピンチ距離計算
      const dx = thumbTip[0] - indexTip[0];
      const dy = thumbTip[1] - indexTip[1];
      const distance = Math.sqrt(dx*dx + dy*dy);

      // ピンチ判定でパネル拡大縮小
      const minDist = 30; // ピンチ最小距離
      const maxDist = 150; // 離すと元のサイズ
      let scale = 1;
      if (distance < minDist) scale = 0.7;
      else if (distance > maxDist) scale = 1;
      else scale = 0.7 + (distance - minDist) / (maxDist - minDist) * 0.3;
      panel.setAttribute('scale', `${scale} ${scale} ${scale}`);

    }
  }
  requestAnimationFrame(detectHands);
}
</script>
</body>
</html>

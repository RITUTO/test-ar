<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AR + Hand Tap</title>
<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; }
  video#input-video { display: none; }
</style>
<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
</head>
<body>
<video id="input-video" autoplay playsinline></video>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
  <a-marker preset="hiro">
    <a-plane id="panel" position="0 0.5 0" width="0.6" height="0.4" color="#ffffff" opacity="0.9">
      <a-text id="panelText" value="Tap with thumb+index" color="#000000" align="center" width="2" position="0 0 0.01"></a-text>
    </a-plane>
  </a-marker>
  <a-entity camera></a-entity>
</a-scene>

<script>
const handSpheres = []
let clicked = false

// A-FRAME上にランドマーク球体を作る関数
const createSphere = (attributes) => {
    const sphere = document.createElement('a-sphere')
    for (const key in attributes) sphere.setAttribute(key, attributes[key])
    document.querySelector('a-scene').appendChild(sphere)
    return sphere
}

// 結果処理
const onResults = (results) => {
    if (results.multiHandLandmarks) {
        for (const landmarks of results.multiHandLandmarks) {

            if (handSpheres.length === 0) {
                landmarks.forEach((landmark) => {
                    const sphere = createSphere({
                        position: { x: landmark.x, y: landmark.y, z: landmark.z },
                        radius: 0.04,
                        color: '#000'
                    })
                    handSpheres.push(sphere)
                })
            }

            handSpheres.forEach((sphere, i) => {
                sphere.setAttribute('position', {
                    x: landmarks[i].x * -3 + 1,
                    y: landmarks[i].y * -2.5 + 2,
                    z: landmarks[i].z * 8 - 2
                })
            })

            // 親指と人差し指の先端でタップ判定
            const thumbTip = landmarks[4]
            const indexTip = landmarks[8]
            const dx = thumbTip.x - indexTip.x
            const dy = thumbTip.y - indexTip.y
            const dz = thumbTip.z - indexTip.z
            const distance = Math.sqrt(dx*dx + dy*dy + dz*dz)

            const clickThreshold = 0.05
            const panelText = document.getElementById('panelText')

            if (distance < clickThreshold && !clicked) {
                clicked = true
                panelText.setAttribute('value', 'Clicked! Loading...')
                setTimeout(() => {
                    window.location.href = 'https://example.com'
                }, 1000)
            } else if (distance >= clickThreshold && clicked) {
                clicked = false
            }
        }
    }
}

const init = () => {
    const videoElement = document.querySelector('#input-video')

    const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    })
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.5
    })
    hands.onResults(onResults)

    const camera = new Camera(videoElement, {
        onFrame: async () => await hands.send({ image: videoElement }),
        width: 1280,
        height: 720
    })
    camera.start()
}

window.onload = init
</script>
</body>
</html>

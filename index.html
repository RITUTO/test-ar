<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARマーカーで手のトラッキングとクリック操作</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    #videoElement { display: none; }
  </style>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
</head>
<body>
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-marker preset="hiro">
      <a-plane id="panel" position="0 0.5 0" width="0.6" height="0.4" color="#ffffff" opacity="0.9">
        <a-text id="panelText" value="X:0 Y:0" color="#000000" align="center" width="2" position="0 0 0.01"></a-text>
      </a-plane>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const video = document.createElement('video');
    let model = null;
    let panelText = document.getElementById('panelText');
    let clicked = false;

    // カメラアクセス
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => { video.srcObject = stream; })
      .catch(err => { alert("カメラアクセス不可: " + err); });

    // MediaPipe Handpose モデル読み込み
    handpose.load().then(loadedModel => {
      model = loadedModel;
      detectHands();
    });

    async function detectHands() {
      if (model && video.readyState === 4) {
        const predictions = await model.estimateHands(video);
        if (predictions.length > 0) {
          const hand = predictions[0];
          const thumbTip = hand.annotations.thumb[3];
          const indexTip = hand.annotations.indexFinger[3];

          // 指先座標をパネルに表示
          const avgX = ((thumbTip[0] + indexTip[0]) / 2).toFixed(0);
          const avgY = ((thumbTip[1] + indexTip[1]) / 2).toFixed(0);
          panelText.setAttribute('value', `X:${avgX} Y:${avgY}`);

          // タップ判定
          const dx = thumbTip[0] - indexTip[0];
          const dy = thumbTip[1] - indexTip[1];
          const distance = Math.sqrt(dx * dx + dy * dy);
          const clickThreshold = 30;

          if (distance < clickThreshold && !clicked) {
            clicked = true;
            panelText.setAttribute('value', 'Clicked! Loading...');
            // 画面切り替え（例として3秒後に別ページへ）
            setTimeout(() => { window.location.href = 'https://example.com'; }, 1000);
          } else if (distance >= clickThreshold && clicked) {
            clicked = false;
          }
        } else {
          panelText.setAttribute('value', 'X:0 Y:0');
          clicked = false;
        }
      }
      requestAnimationFrame(detectHands);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iOS対応 マーカーAR + Hand Tracking Vision UI</title>
<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; }
  #hint {
    position: fixed; top: 10px; left: 10px;
    background: rgba(255,255,255,0.8); padding: 6px 10px; border-radius: 6px; z-index:10;
  }
  #videoElement { display: none; }
</style>
<!-- A-Frame -->
<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<!-- AR.js -->
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
<!-- TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose"></script>
</head>
<body>
<div id="hint">Hiroマーカーをカメラに向けてください。指でパネルをタッチして色が変わります。</div>
<video id="videoElement" autoplay playsinline></video>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
  <!-- Hiroマーカー -->
  <a-marker preset="hiro">
    <!-- Vision風パネル -->
    <a-plane id="panel" position="0 0.5 0" width="0.6" height="0.4" color="#ffffff" opacity="0.9">
      <a-text id="panelText" value="Touch Me" color="#000000" align="center" width="2" position="0 0 0.01"></a-text>
    </a-plane>
  </a-marker>
  <a-entity camera></a-entity>
</a-scene>

<script>
const video = document.getElementById('videoElement');
let model = null;
let panel = document.getElementById('panel');

// カメラアクセス
navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
.then(stream => { video.srcObject = stream; })
.catch(err => { alert("カメラアクセス不可: " + err); });

// MediaPipe Handpose モデル読み込み
handpose.load().then(loadedModel => {
  model = loadedModel;
  detectHands();
});

// 手の検出ループ
async function detectHands() {
  if (model && video.readyState === 4) {
    const predictions = await model.estimateHands(video);
    if (predictions.length > 0) {
      // 指先座標 (ランドマーク 8 = 人差し指先)
      const tip = predictions[0].annotations.indexFinger[3]; // [x, y, z]
      const x = tip[0]; // video座標
      const y = tip[1];
      
      // パネル座標と照合（簡易2D判定）
      const panelRect = { x: video.videoWidth/2, y: video.videoHeight/2, width: 200, height: 120 };
      if (Math.abs(x - panelRect.x) < panelRect.width/2 && Math.abs(y - panelRect.y) < panelRect.height/2) {
        panel.setAttribute('color', '#ffcc00'); // タッチしたら色変更
      } else {
        panel.setAttribute('color', '#ffffff');
      }
    } else {
      panel.setAttribute('color', '#ffffff');
    }
  }
  requestAnimationFrame(detectHands);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apple Vision風 AR UI</title>
<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; }
  video#input-video { display: none; }
</style>
<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
</head>
<body>
<video id="input-video" autoplay playsinline></video>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
  <a-marker preset="hiro">

    <!-- 浮かぶパネル -->
    <a-plane id="panel" position="0 0.5 0" width="0.8" height="0.5" color="#ffffff" opacity="0.95" rotation="-10 0 0">
      <!-- ボタン1 -->
      <a-plane id="btn1" position="-0.25 0.1 0.01" width="0.3" height="0.15" color="#4CAF50" class="button">
        <a-text value="Button 1" align="center" color="#fff" width="2" position="0 0 0.01"></a-text>
      </a-plane>
      <!-- ボタン2 -->
      <a-plane id="btn2" position="0.25 0.1 0.01" width="0.3" height="0.15" color="#2196F3" class="button">
        <a-text value="Button 2" align="center" color="#fff" width="2" position="0 0 0.01"></a-text>
      </a-plane>
      <!-- ボタン3 -->
      <a-plane id="btn3" position="0 -0.2 0.01" width="0.6" height="0.15" color="#FF9800" class="button">
        <a-text value="Button 3" align="center" color="#fff" width="2" position="0 0 0.01"></a-text>
      </a-plane>
    </a-plane>

  </a-marker>
  <a-entity camera></a-entity>
</a-scene>

<script>
const handSpheres = []
let clicked = false

const buttons = [
  { el: document.getElementById('btn1'), action: () => { window.location.href = 'https://example.com/1' } },
  { el: document.getElementById('btn2'), action: () => { window.location.href = 'https://example.com/2' } },
  { el: document.getElementById('btn3'), action: () => { window.location.href = 'https://example.com/3' } },
]

// 球体作成
const createSphere = (attributes) => {
  const sphere = document.createElement('a-sphere')
  for (const key in attributes) sphere.setAttribute(key, attributes[key])
  document.querySelector('a-scene').appendChild(sphere)
  return sphere
}

// タップ判定
const checkButtonClick = (x, y, z) => {
  buttons.forEach(btn => {
    const pos = btn.el.getAttribute('position')
    const width = btn.el.getAttribute('width')
    const height = btn.el.getAttribute('height')

    // 簡易的にパネルローカル座標系で距離判定
    if (
      x > pos.x - width/2 && x < pos.x + width/2 &&
      y > pos.y - height/2 && y < pos.y + height/2
    ) {
      btn.el.setAttribute('color', '#888') // 視覚フィードバック
      btn.action()
    }
  })
}

// MediaPipe結果処理
const onResults = (results) => {
  if (results.multiHandLandmarks) {
    const landmarks = results.multiHandLandmarks[0]

    if (handSpheres.length === 0) {
      landmarks.forEach(landmark => {
        const sphere = createSphere({
          position: { x: landmark.x, y: landmark.y, z: landmark.z },
          radius: 0.035,
          color: '#000'
        })
        handSpheres.push(sphere)
      })
    }

    handSpheres.forEach((sphere, i) => {
      sphere.setAttribute('position', {
        x: landmarks[i].x * -2.5 + 0.9,
        y: landmarks[i].y * -2.2 + 1.8,
        z: landmarks[i].z * 7 - 1.5
      })
    })

    const thumbTip = landmarks[4]
    const indexTip = landmarks[8]
    const dx = thumbTip.x - indexTip.x
    const dy = thumbTip.y - indexTip.y
    const dz = thumbTip.z - indexTip.z
    const distance = Math.sqrt(dx*dx + dy*dy + dz*dz)

    if (distance < 0.045 && !clicked) {
      clicked = true
      // 平均座標でタップ判定
      const avgX = (thumbTip.x + indexTip.x)/2 * -2.5 + 0.9
      const avgY = (thumbTip.y + indexTip.y)/2 * -2.2 + 1.8
      const avgZ = (thumbTip.z + indexTip.z)/2 * 7 - 1.5
      checkButtonClick(avgX, avgY, avgZ)
    } else if (distance >= 0.045 && clicked) {
      clicked = false
    }
  }
}

const init = () => {
  const videoElement = document.querySelector('#input-video')
  const hands = new Hands({
    locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  })
  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
  })
  hands.onResults(onResults)

  const camera = new Camera(videoElement, {
    onFrame: async () => await hands.send({ image: videoElement }),
    width: 1280,
    height: 720
  })
  camera.start()
}

window.onload = init
</script>
</body>
</html>
